<!DOCTYPE html>
<html lang="ru">
<head>
    <title>Выставление счетов</title>
    <meta charset="utf-8">
    <link href="../../assets/css/bootstrap.min.css" rel="stylesheet">
    <link href="../../assets/css/bootstrap-reboot.min.css" rel="stylesheet">
    <link rel="stylesheet" href="../../assets/css/style.css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
    <style>.progress-bar{display: flex;align-items: center;flex-direction: row}</style>
</head>
<body>
<div class="container-fluid">
    <div class="text-center">
        <h1>Выставление счетов</h1>
    </div>
</div>

<div class="container-fluid">
    <div class="row mt-3 mb-xl-5">
        <div class="col-3 m-auto">
            <div class="card mt-3" id="InputNewInvoice">
                <h5 class="card-header">Выставить счета по списку</h5>
                <div class="card-body">
                    <form class="form" id="formdata">
                        <div class="share-form">
                            <div class="d-flex">
                                <div class="custom-file">
                                    <input type="file" class="custom-file-input" id="InputNewInvoiceChooseFile" name="uploaded_file" lang="ru" aria-describedby="InputNewInvoiceChooseFile" required>
                                    <label class="custom-file-label" for="InputNewInvoiceChooseFile" data-browse="Обзор">Выберите файл</label>
                                </div>
                                <div>
                                    <button class="btn btn-outline-secondary" type="button" id="InputNewInvoiceAdd_Button">Загрузить</button>
                                </div>
                            </div>
                            <div class="text-center mt-2">
                                <input type="week" id="week" name="week" required>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="card-footer" id="InputNewInvoiceFooter" >
                    <div class="progress" style="height: 20px;" id="progress" hidden="hidden">
                        <div class="progress-bar progress-bar-striped" id="general-progress" role="progressbar" style="min-width: 3em" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                            <i class="fa fa-spinner fa-spin fa-fw" hidden="hidden"></i><span id="progress-value">0%</span>
                        </div>
                    </div>
                    <p class="text-success font-weight-bold" id="successStatementInputNewInvoice" hidden="hidden">success</p>
                    <p class="text-danger font-weight-bold" id="warningStatementInputNewInvoice" hidden="hidden">warning</p>
                </div>
			</div>
		</div>
	</div>
</div>

<script src="https://code.jquery.com/jquery-latest.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/js/bootstrap.min.js" integrity="sha384-B0UglyR+jN6CkvvICOB2joaf5I4l3gm9GU6Hc1og6Ls7i6U/mkkaduKaBhlAXv9k" crossorigin="anonymous"></script>
<script>
    $(document).ready(function () {
        let flag = false;
        // Нажатие кнопки выбор файла
        $('#InputNewInvoiceChooseFile, #week').on('change',function(){
            // получаем имя файла
            var fileName = $(this).val();
            // измените значение "fake path" (в Chrome) на пустую строку
            fileName = fileName.replace("C:\\fakepath\\", "");
            // заменяем надпись "Выберите файл" в label
            $(this).next('.custom-file-label').html(fileName);

            let percent = 0;
            $( "#general-progress" ).css('width', percent + '%');
            $( "#progress-value" ).html(percent + '%');
            $( "#progress" ).prop('hidden', true);
            $( ".fa-spinner" ).prop('hidden', true);
            $( "#general-progress" ).removeClass('progress-bar-animated');

            if( this.value ){
                flag = true;
                console.log( "Выбрали файл!" ); 
            } else { // Если после выбранного тыкнули еще раз, но дальше cancel
                flag = false;
                console.log( "Файл не выбран" );
                $(this).next('.custom-file-label').html("Выберите файл");
                 
            }
        })
        
        
        $('#InputNewInvoiceAdd_Button').click(function () {
            let week = document.getElementById("week");
            let warningStatement2 = document.getElementById("warningStatementInputNewInvoice");
            // Step 0 we selected the file and the number of the week
            let percent = 2;
            $( "#general-progress" ).css('width', percent + '%');
            $( "#progress-value" ).html(percent + '%');
            $( "#progress" ).prop('hidden', false);
            $( ".fa-spinner" ).prop('hidden', false);
            $( "#general-progress" ).addClass('progress-bar-animated');

            if (flag && (week.value != '')) {
                percent = 6;
                $( "#general-progress" ).css('width', percent + '%');
                $( "#progress-value" ).html(percent + '%');
                $( "#warningStatementInputNewInvoice" ).prop('hidden', true);
            }else{
                if (!flag) {warningStatement2.innerHTML = 'Выбирете файл';}                
                if (week.value == '') {warningStatement2.innerHTML = 'Выбирете период';}
                if (!flag && (week.value == '')) {warningStatement2.innerHTML = 'Выбирете файл и период';}
                $( "#warningStatementInputNewInvoice" ).prop('hidden', false);
                // alert('Выбирете файл');
                $( "#progress" ).prop('hidden', true);
                $( ".fa-spinner" ).prop('hidden', true);
                $( "#general-progress" ).removeClass('progress-bar-animated');
                return false;
            }

            
            // Step 1 reading a file
            //////////////////////////////////////////////////////
            // let files = document.querySelector('#InputNewInvoiceChooseFile').files;
            // console.log(files);

            let data = new FormData($('#formdata').get(0));
            $.ajax({
                url         : 'check.php',
                type        : 'POST', // важно!
                data        : data,
                cache       : false,
                // dataType    : 'json',
                // отключаем обработку передаваемых данных, пусть передаются как есть
                processData : false,
                // отключаем установку заголовка типа запроса. Так jQuery скажет серверу что это строковой запрос
                contentType : false,

                beforeSend : function(){

                },

                complete : function(){

                },

                success : function(respond, status, jqXHR ){
                    console.log(respond);
                    let percent = 10;
                    $( "#general-progress" ).css('width', percent + '%');
                    $( "#progress-value" ).html(percent + '%');
                },

                error: function( jqXHR, status, errorThrown ){

                }
            
            })


        // Step 2 search for the company ID by internal number


        // Step 3 recording the mass and period in the company


        // Step 4 search for a deal by company ID 


        // Step 5 Choosing a direction Оплата по Кг


        })
    })    
</script>       

</body>
</html>